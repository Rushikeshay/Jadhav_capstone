<div class="container py-4">
  <nav class="mb-4">
    <a href="/days/<%= @the_activity.day_id %>" class="btn btn-outline-secondary btn-sm">
      <i class="fa-solid fa-arrow-left"></i> Back to Day Plan
    </a>
  </nav>

  <div class="row">
    <div class="col-md-6">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
          <h2 class="h5 mb-0">Edit Activity Details</h2>
        </div>
        <div class="card-body">
          <form action="/modify_activity/<%= @the_activity.id %>" method="post">
            <div class="mb-3">
              <label for="name_box" class="form-label fw-bold">Name</label>
              <input type="text" id="name_box" name="query_name" value="<%= @the_activity.name %>" class="form-control">
            </div>

            <div class="mb-3">
              <label for="address_box" class="form-label fw-bold">Address</label>
              <input type="text" id="address_box" name="query_address" value="<%= @the_activity.address %>" class="form-control">
            </div>

            <div class="row mb-3">
              <div class="col">
                <label for="cost_box" class="form-label fw-bold">Cost</label>
                <input type="text" id="cost_box" name="query_cost" value="<%= @the_activity.cost %>" class="form-control">
              </div>
              <div class="col">
                <label for="any_cost_box" class="form-label fw-bold">Any cost?</label>
                <input type="text" id="any_cost_box" name="query_any_cost" value="<%= @the_activity.any_cost %>" class="form-control">
              </div>
            </div>

            <div class="mb-3">
              <label for="notes_box" class="form-label fw-bold">Notes</label>
              <textarea id="notes_box" name="query_notes" rows="4" class="form-control"><%= @the_activity.notes %></textarea>
            </div>

            <input type="hidden" name="query_day_id" value="<%= @the_activity.day_id %>">

            <div class="d-grid">
              <button type="submit" class="btn btn-success">Update Logistics</button>
            </div>
          </form>
        </div>
      </div>

      <a href="/delete_activity/<%= @the_activity.id %>" class="text-danger small" onclick="return confirm('Delete this activity?')">
        Delete Activity
      </a>
    </div>

    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="h5 mb-0">Activity Gallery</h2>
          <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#photoModal">
            <i class="fa-solid fa-camera"></i> Add Picture
          </button>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <% if @the_activity.photos.any? %>
              <% @the_activity.photos.each do |photo| %>
                <div class="col-6">
                  <div class="card h-100 shadow-sm">
                    <img src="<%= photo.image %>" class="card-img-top" alt="Gallery image" style="height: 150px; object-fit: cover;">
                    <% if photo.caption.present? %>
                      <div class="card-footer p-1 text-center">
                        <small class="text-muted"><%= photo.caption %></small>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            <% else %>
              <div class="text-center py-5 border rounded bg-light w-100">
                <i class="fa-regular fa-image fa-3x text-secondary mb-2"></i>
                <p class="text-secondary">No pictures yet. Click the button above to add one!</p>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%# ===== Engagement: Likes & Comments ===== %>
<div class="container py-2 pb-4">
  <div class="row g-4">
    <%# Likes panel %>
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header d-flex align-items-center gap-2">
          <i class="fa-solid fa-heart text-danger"></i>
          <h5 class="mb-0"><%= @the_activity.likes.count %> Likes</h5>
        </div>
        <div class="card-body">
          <% if @the_activity.likes.includes(:user).any? %>
            <div class="d-flex flex-wrap gap-2">
              <% @the_activity.likes.includes(:user).each do |like| %>
                <span class="badge rounded-pill bg-light text-dark border d-flex align-items-center gap-1 py-2 px-3">
                  <% if like.user&.avatar&.url.present? %>
                    <img src="<%= like.user.avatar.url %>" class="rounded-circle"
                         style="width:20px;height:20px;object-fit:cover;" alt="">
                  <% else %>
                    <i class="fa-solid fa-user text-secondary" style="font-size:0.7rem;"></i>
                  <% end %>
                  <%= like.user&.username.presence || like.user&.first_name.presence || "User" %>
                </span>
              <% end %>
            </div>
          <% else %>
            <p class="text-muted small mb-0">No likes yet.</p>
          <% end %>
        </div>
      </div>
    </div>

    <%# Comments panel %>
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header d-flex align-items-center gap-2">
          <i class="fa-regular fa-comment"></i>
          <h5 class="mb-0"><%= @the_activity.comments.count %> Comments</h5>
        </div>
        <div class="card-body">
          <% if @the_activity.comments.includes(:user).any? %>
            <% @the_activity.comments.includes(:user).order(:created_at).each do |comment| %>
              <div class="d-flex align-items-start gap-2 mb-3">
                <% if comment.user&.avatar&.url.present? %>
                  <img src="<%= comment.user.avatar.url %>" class="rounded-circle"
                       style="width:30px;height:30px;object-fit:cover;flex-shrink:0;" alt="">
                <% else %>
                  <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center"
                       style="width:30px;height:30px;flex-shrink:0;">
                    <i class="fa-solid fa-user text-white" style="font-size:0.7rem;"></i>
                  </div>
                <% end %>
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between align-items-baseline">
                    <span class="fw-semibold small">
                      <%= comment.user&.username.presence || comment.user&.first_name.presence || "User" %>
                    </span>
                    <span class="text-muted" style="font-size:0.7rem;">
                      <%= time_ago_in_words(comment.created_at) %> ago
                    </span>
                  </div>
                  <p class="mb-0 small"><%= comment.body %></p>
                </div>
              </div>
            <% end %>
          <% else %>
            <p class="text-muted small mb-0">No comments yet.</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="/insert_photo" method="post" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title" id="photoModalLabel">Upload New Photo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
             <label for="image_box" class="form-label fw-bold">Choose Image</label>
             <input type="file" id="image_box" name="query_image" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="caption_box" class="form-label fw-bold">Caption</label>
            <input type="text" id="caption_box" name="query_caption" placeholder="Describe this photo..." class="form-control">
          </div>
          
          <input type="hidden" name="query_activity_id" value="<%= @the_activity.id %>">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Upload to Gallery</button>
        </div>
      </form>
    </div>
  </div>
</div>
